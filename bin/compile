#!/bin/sh

indent() {
  sed -u 's/^/       /'
}

log() {
  echo $1 | indent
}

BUILD_DIR=$1
CACHE_DIR=$2

mkdir -p ${CACHE_DIR}

log "Cache dir: ${CACHE_DIR}"

export PLENV_ROOT=${CACHE_DIR}/.plenv

if [ ! -e "${PLENV_ROOT}" ]; then
  log "Downloading plenv..."
  git clone https://github.com/tokuhirom/plenv.git ${PLENV_ROOT}
fi

export PATH=${PLENV_ROOT}/bin:$PATH
eval "$(plenv init -)"

env

if [ ! -e "${PLENV_ROOT}/plugins/perl-build" ]; then
  log "Downloading perl-build..."
  git clone https://github.com/tokuhirom/Perl-Build.git ${PLENV_ROOT}/plugins/perl-build
fi

if [ -e "$BUILD_DIR/.perl-version" ]; then
  PERL_VERSION=`cat $BUILD_DIR/.perl-version`
else
  echo "No perl version defined"
  exit 1
fi

log "Perl version required: ${PERL_VERSION}"

log "Installed perls:"
plenv versions

if ! plenv versions | grep "${PERL_VERSION}"; then
  log "Installing required perl..."
  plenv install ${PERL_VERSION}
fi

plenv rehash
