#!/bin/sh

indent() {
  sed -u 's/^/       /'
}

log() {
  echo $1 | indent
}

log_section() {
  echo "-----> $1"
}

BUILD_DIR=$1
CACHE_DIR=$2

mkdir -p ${CACHE_DIR}

log "Cache dir: ${CACHE_DIR}"

export PLENV_ROOT=${CACHE_DIR}/.plenv

if [ ! -e "${PLENV_ROOT}" ]; then
  log_section "Downloading plenv..."
  git clone https://github.com/tokuhirom/plenv.git ${PLENV_ROOT}
fi

export PATH=${PLENV_ROOT}/bin:$PATH
eval "$(plenv init -)"

env

if [ ! -e "${PLENV_ROOT}/plugins/perl-build" ]; then
  log_section "Downloading perl-build..."
  git clone https://github.com/tokuhirom/Perl-Build.git ${PLENV_ROOT}/plugins/perl-build
fi

cd $BUILD_DIR

if [ -e ".perl-version" ]; then
  PERL_VERSION=`cat .perl-version`
else
  echo "No perl version defined"
  exit 1
fi

log "Perl version required: ${PERL_VERSION}"

if ! plenv versions | grep "${PERL_VERSION}"; then
  log_section "Installing required perl..."
  plenv install ${PERL_VERSION}
  plenv rehash
fi

log "Installed perls:"
plenv versions

log_section "Installing base dependencies..."
log "Installing cpanm..."
plenv install-cpanm

log "Installing carton..."
cpanm Carton
